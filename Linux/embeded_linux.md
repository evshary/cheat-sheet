# Introduction

To build up your own embeded Linux, you need compiler, uboot, Linux, rootfs.

# Compile Tool

## crosstool-NG

Use crosstool-NG to build your own compiler tool

* Download crosstool-NG from [`http://crosstool-ng.org/download/crosstool-ng/`](http://crosstool-ng.org/download/crosstool-ng/)
* Decompress and build
    
```bash
tar xf crosstool-ng-1.24.0-rc3.tar.bz2
cd crosstool-ng-1.24.0-rc3
./configure --enable-local
make
```
    
* Select your cross compiler
    
```bash
# List all the settings
./ct-ng list-samples
# show settings
./ct-ng show-arm-unknown-linux-gnueabi
# select your settings
./ct-ng arm-unknown-linux-gnueabi
# Configure
# Remove Render the toolchain read-only from PATH and misc
# Select hardware(FPU) in Target options | Floating point
# Add --enable-obsolete-rpc in C-library | extra config
./ct-ng menuconfig
# Compile
./ct-ng build
```
    
* Compiler will be under `~/x-tools/arm-cortex_a8-linux-gnueabihf/bin/`
  - Add PATH

```bash
PATH=~/x-tools/arm-cortex_a8-linux-gnueabihf/bin/:$PATH
```

## Download existed compiler from vendors

```bash
wget https://sourcery.mentor.com/GNUToolchain/package12813/public/arm-none-linux-gnueabi/arm-2014.05-29-arm-none-linux-gnueabi-i686-pc-linux-gnu.tar.bz2
tar xvf arm-2014.05-29-arm-none-linux-gnueabi-i686-pc-linux-gnu.tar.bz2
PATH=<path to "arm-2014.05/bin">:$PATH
# for example
PATH=~/workspace/cross_compiler_test/arm-2014.05/bin/:$PATH
```

## Use apt install

```bash
sudo apt install gcc-arm-linux-gnueabi
```

# Build uboot

* Get uboot source code

```bash
git clone git://git.denx.de/u-boot.git
```

* Compile

```bash
cd u-boot
# Setup config
make ARCH=arm vexpress_ca9x4_defconfig
# Use the compiler generated by yourself
make ARCH=arm CROSS_COMPILE=arm-cortex_a8-linux-gnueabihf-
# Use the compiler from other vendors
make ARCH=arm CROSS_COMPILE=arm-none-linux-gnueabi-
# Use the compiler from Ubuntu
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-
```

* Test with qemu
  - If you want to stop, press ctrl+a, and then x.

```bash
qemu-system-arm -M vexpress-a9 -m 256 -kernel u-boot --nographic
```

# Build Linux

* Get the code

```bash
git clone https://github.com/torvalds/linux.git
cd linux
git checkout v4.1.10
```

* According to your compiler

```bash
# Use the compiler generated by yourself
export CROSS_COMPILE=arm-cortex_a8-linux-gnueabihf-
# Use the compiler from other vendors
export CROSS_COMPILE=arm-none-linux-gnueabi-
# Use the compiler from Ubuntu
export CROSS_COMPILE=arm-linux-gnueabi-
```

* Build
  
```bash
make ARCH=arm distclean
make ARCH=arm vexpress_defconfig
# 3
make ARCH=arm
# 4
make ARCH=arm modules
# 5: need mkimage (Able to get from tools folder in u-boot)
make ARCH=arm uImage LOADADDR=0x60000000
# 6
make ARCH=arm dtbs

# If you only want to test file system and kernel, use the following commands to replace 3-6
make ARCH=arm all
```

* Test with qemu
  - Should be panic since lack of file system

```bash
qemu-system-arm -M vexpress-a9 -m 512 -kernel arch/arm/boot/zImage -nographic -append "console=ttyAMA0" -dtb arch/arm/boot/dts/vexpress-v2p-ca9.dtb
```

# Generate rootfs

* Build busybox

```bash
git clone git://busybox.net/busybox.git
# Since busybox git often fails, use the following link instead
wget https://busybox.net/downloads/busybox-1.31.1.tar.bz2
make distclean
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- defconfig
# Need to build with static: under "Setting->Build static binary"
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- menuconfig
make -j 4 ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-
# Create _install
make -j 4 ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- install
```

## Generate initramfs

* Copy folder

```bash
mkdir rootfs
cd rootfs
mkdir -pv {bin,sbin,etc,proc,sys,usr/{bin,sbin}}
cp -r ../_install/* .
```

* Generate init script

```bash
vim init
-----------------
#!/bin/sh
 
mount -t proc none /proc
mount -t sysfs none /sys
 
echo -e "\nBoot took $(cut -d' ' -f1 /proc/uptime) seconds\n"
 
exec /bin/sh
-----------------
chmod +x init
```

* Create rootfs

```bash
find . -print0 | cpio --null -ov --owner root:root --format=newc | gzip -9 > ./initramfs-busybox-arm.cpio.gz
```

* Rerun qemu

```bash
mv initramfs-busybox-arm.cpio.gz ../../
cd ../../
qemu-system-arm -M vexpress-a9 -m 512 -kernel linux/arch/arm/boot/zImage -initrd initramfs-busybox-arm.cpio.gz -nographic -append "console=ttyAMA0" -dtb linux/arch/arm/boot/dts/vexpress-v2p-ca9.dtb
```

## Use SD card

* Generate SD card and mount

```bash
dd if=/dev/zero of=sdcard.ext3 bs=1M count=32
mkfs.ext3 sdcard.ext3
sudo rm -fr rootfs;
mkdir rootfs
sudo mount -t ext3 -o loop sdcard.ext3  rootfs/
cd rootfs
```

* Create rootfs

```bash
sudo mkdir lib proc sys dev etc etc/init.d
sudo cp -r ../_install/* .
sudo cp -P /usr/arm-linux-gnueabi/lib/*  lib/


sudo cp ../examples/bootfloppy/etc/inittab  etc/
sudo touch etc/init.d/rcS
sudo chmod 0777 etc/init.d/rcS
sudo echo "#!/bin/sh" >> etc/init.d/rcS
sudo echo "mount -t proc none /proc" >> etc/init.d/rcS
sudo echo "mount -t sysfs none /sys" >> etc/init.d/rcS
sudo echo "mount -t tmpfs none /dev" >> etc/init.d/rcS
sudo echo "/sbin/mdev -s" >> etc/init.d/rcS
sudo chmod 0755 etc/init.d/rcS
```

* umount SD card

```bash
cd ..
sudo umount rootfs/
mv sdcard.ext3 ../..
```

* Run qemu

```bash
qemu-system-arm -M vexpress-a9 -m 512 -kernel linux/arch/arm/boot/zImage -sd sdcard.ext3 -nographic -append "console=ttyAMA0 rootwait rw root=/dev/mmcblk0 init=/linuxrc" -dtb linux/arch/arm/boot/dts/vexpress-v2p-ca9.dtb
```

# Boot from uboot and run Linux

* Settings TFTP

```bash
sudo apt install tftp-hpa tftpd-hpa
# Check the path of TFTP_DIRECTORY in "/etc/default/tftpd-hpa", and then copy kernel image
sudo cp linux/arch/arm/boot/zImage /var/lib/tftpboot
sudo systemctl start tftpd-hpa.service
```

* Test with TFTP

```bash
tftp localhost
tftp> get zImage
tftp> quit
ls zImage
```

* Install TUN/TAP network

```bash
sudo apt install bridge-utils uml-utilities
```

* Boot from uboot

```bash
qemu-system-arm -M vexpress-a9 -m 512 --nographic -net nic -net tap,ifname=tap0,script=no -sd sdcard.ext3 -kernel u-boot/u-boot
```

# Reference
* Use the compiler from vendors, but lack of how to build uboot (gcc version is too old)
  - [https://hackmd.io/@c_0KKCwzQE2rsd39mpvNQQ/rknxhDzvB](https://hackmd.io/@c_0KKCwzQE2rsd39mpvNQQ/rknxhDzvB)
* Generate the compiler by yourself and build from the beginning to the end
  - [https://www.latelee.org/ellp/ellp-qemu-start.html](https://www.latelee.org/ellp/ellp-qemu-start.html)
* Use TFTP to boot from uboot to Linux
  - [https://www.itread01.com/content/1533316818.html](https://www.itread01.com/content/1533316818.html)
  - [https://www.itread01.com/content/1561550824.html](https://www.itread01.com/content/1561550824.html)
* [基於QEMU搭建完整的虛擬ARM開發環境(uboot+linux+rootfs)](https://www.itread01.com/content/1547681225.html)
