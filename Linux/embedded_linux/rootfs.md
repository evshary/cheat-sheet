# initramfs & rootfs

In Linux, we needs initramfs to load necessary kernel modules (driver) and then we can use this modules to load rootfs from disk.

* initramfs: often put under /boot
* rootfs: often put under disk, and we need driver to read disk

# Build busybox

* According to your compiler

```bash
# Use the compiler generated by yourself
export CROSS_COMPILE=arm-unknown-linux-gnueabihf-
# Use the compiler from other vendors
export CROSS_COMPILE=arm-none-linux-gnueabi-
# Use the compiler from Ubuntu
export CROSS_COMPILE=arm-linux-gnueabi-
```

* Build busybox

```bash
git clone git://busybox.net/busybox.git
# Since busybox git often fails, use the following link instead
wget https://busybox.net/downloads/busybox-1.35.0.tar.bz2
# Enter busybox
make distclean
make ARCH=arm defconfig
# Need to build with static: under "Setting->Build static binary"
make ARCH=arm menuconfig
make -j 8 ARCH=arm
# Create _install
make -j 8 ARCH=arm install
```

# Generate initramfs

* Copy folder

```bash
mkdir rootfs
cd rootfs
mkdir -pv {bin,sbin,etc,proc,sys,usr/{bin,sbin}}
cp -r ../_install/* .
# Optional: Copy cross compiler library (If you use static binary, ignore this step)
cp /usr/arm-linux-gnueabi/lib/* lib
```

* Generate init script

```bash
vim init
-----------------
#!/bin/sh
 
mount -t proc none /proc
mount -t sysfs none /sys
 
echo -e "\nBoot took $(cut -d' ' -f1 /proc/uptime) seconds\n"
 
exec /bin/sh
-----------------
chmod +x init
```

* Create initramfs

```bash
find . -print0 | cpio --null -ov --owner root:root --format=newc | gzip -9 > ./initramfs-busybox-arm.cpio.gz
```

* Rerun qemu

```bash
mv initramfs-busybox-arm.cpio.gz ../../
cd ../../
qemu-system-arm -M vexpress-a9 -m 512 -kernel linux/arch/arm/boot/zImage -initrd initramfs-busybox-arm.cpio.gz -nographic -append "console=ttyAMA0" -dtb linux/arch/arm/boot/dts/vexpress-v2p-ca9.dtb
```

# Generate rootfs in SD card

* Generate SD card and mount

```bash
dd if=/dev/zero of=sdcard.ext3 bs=1M count=32
mkfs.ext3 sdcard.ext3
sudo rm -rf rootfs
mkdir rootfs
sudo mount -t ext3 -o loop sdcard.ext3  rootfs/
cd rootfs
```

* Create rootfs

```bash
sudo mkdir lib proc sys dev etc etc/init.d
sudo cp -r ../busybox/_install/* .
sudo cp -P /usr/arm-linux-gnueabi/lib/*  lib/

sudo cp ../busybox/examples/bootfloppy/etc/inittab  etc/
sudo touch etc/init.d/rcS
sudo chmod 0777 etc/init.d/rcS
sudo echo "#!/bin/sh" >> etc/init.d/rcS
sudo echo "mount -t proc none /proc" >> etc/init.d/rcS
sudo echo "mount -t sysfs none /sys" >> etc/init.d/rcS
sudo echo "mount -t tmpfs none /dev" >> etc/init.d/rcS
sudo echo "/sbin/mdev -s" >> etc/init.d/rcS
sudo chmod 0755 etc/init.d/rcS
```

* umount SD card

```bash
cd ..
sudo umount rootfs/
```

* Run qemu

```bash
qemu-system-arm -M vexpress-a9 -m 512 -kernel linux/arch/arm/boot/zImage -sd sdcard.ext3 -nographic -append "console=ttyAMA0 rootwait rw root=/dev/mmcblk0 init=/linuxrc" -dtb linux/arch/arm/boot/dts/vexpress-v2p-ca9.dtb
```

# The relationship between initramfs and rootfs

We need to know the flow of kernel booting:

* load kernel and initial RAM disk
* Convert initrd to normal RAM disk
* Run init in RAM disk
* init will mount real rootfs (based on `root=` in cmdline)
* init will use pivot_root system call to change to new rootfs
* init will run /sbin/init in rootfs
* Remove initrd

Refer to [Using the initial RAM disk (initrd) in kernel](https://www.kernel.org/doc/html/latest/admin-guide/initrd.html#operation)

## View the content of initrd

In Ubuntu, there are some tools to see the content of initrd.img

* See the file list: `lsinitramfs /boot/initrd.img`
* Extract the file: `unmkinitramfs /boot/initrd.img tmp`
  - The init script will be under `tmp/main/init`
